#!/usr/bin/env bash
# VanSkills - Validate skill definitions
# Usage: ./bin/validate [skill-name]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
SKILLS_DIR="$REPO_ROOT/skills"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Counters
ERRORS=0
WARNINGS=0
VALIDATED=0

# Extract YAML frontmatter field
extract_field() {
    local file="$1"
    local field="$2"
    awk -v field="$field" '
        /^---$/ { in_frontmatter = !in_frontmatter; next }
        in_frontmatter && $1 == field":" {
            sub(/^[^:]+:[[:space:]]*/, "")
            if ($0 != "" && $0 != ">") {
                gsub(/^["'\''"]|["'\''"]$/, "")
                print
                exit
            }
            getline
            while (/^[[:space:]]/ && !/^---$/) {
                sub(/^[[:space:]]+/, "")
                printf "%s ", $0
                if (!getline) break
            }
            print ""
            exit
        }
    ' "$file" | sed 's/[[:space:]]*$//'
}

# Extract nested metadata field
extract_metadata() {
    local file="$1"
    local field="$2"

    awk -v field="$field" '
        function trim(s) {
            sub(/^[[:space:]]+/, "", s)
            sub(/[[:space:]]+$/, "", s)
            return s
        }

        /^---$/ { in_frontmatter = !in_frontmatter; next }

        in_frontmatter && /^metadata:/ { in_metadata = 1; next }
        in_frontmatter && in_metadata && /^[a-z]/ && !/^[[:space:]]/ { in_metadata = 0 }

        in_frontmatter && in_metadata && $1 == field":" {
            sub(/^[^:]+:[[:space:]]*/, "")

            if ($0 != "") {
                v = $0
                gsub(/^["'\''"]|["'\''"]$/, "", v)
                gsub(/^\[|\]$/, "", v)
                print trim(v)
                exit
            }

            out = ""
            while (getline) {
                if (!in_frontmatter) break
                if (!in_metadata) break
                if ($0 ~ /^[a-z]/ && $0 !~ /^[[:space:]]/) break

                line = $0
                if (line ~ /^[[:space:]]*-[[:space:]]*/) {
                    sub(/^[[:space:]]*-[[:space:]]*/, "", line)
                    line = trim(line)
                    gsub(/^["'\''"]|["'\''"]$/, "", line)
                    if (line != "") {
                        if (out == "") out = line
                        else out = out "|" line
                    }
                } else {
                    break
                }
            }

            if (out != "") print out
            exit
        }
    ' "$file"
}

# Extract dependencies array
extract_dependencies() {
    local file="$1"

    awk '
        function trim(s) {
            sub(/^[[:space:]]+/, "", s)
            sub(/[[:space:]]+$/, "", s)
            return s
        }

        /^---$/ { in_frontmatter = !in_frontmatter; next }

        in_frontmatter && /^metadata:/ { in_metadata = 1; next }
        in_frontmatter && in_metadata && /^[a-zA-Z]/ && !/^[[:space:]]/ { in_metadata = 0 }

        in_frontmatter && in_metadata && /^[[:space:]]+dependencies:/ {
            in_deps = 1
            next
        }

        in_frontmatter && in_metadata && in_deps {
            # Exit if we hit a new field (not starting with -)
            if ($0 ~ /^[[:space:]]+[a-zA-Z_-]+:/ && $0 !~ /^[[:space:]]*-/) {
                exit
            }
            # Exit if line doesnt start with spaces
            if ($0 !~ /^[[:space:]]/) {
                exit
            }
            # Process list items
            if ($0 ~ /^[[:space:]]*-[[:space:]]/) {
                line = $0
                sub(/^[[:space:]]*-[[:space:]]*/, "", line)
                line = trim(line)
                gsub(/^["'\''"]|["'\''"]$/, "", line)
                if (line != "" && line !~ /^#/) print line
            }
        }
    ' "$file"
}

# Get all skill names
get_all_skills() {
    find "$SKILLS_DIR" -mindepth 2 -maxdepth 2 -name SKILL.md -print | while read -r f; do
        extract_field "$f" "name"
    done
}

validate_skill() {
    local skill_file="$1"
    local skill_dir=$(dirname "$skill_file")
    local skill_folder=$(basename "$skill_dir")
    local errors=0
    local warnings=0

    echo -e "${BLUE}Validating: $skill_folder${NC}"

    # Check frontmatter exists
    if ! head -1 "$skill_file" | grep -q "^---$"; then
        echo -e "  ${RED}ERROR: Missing YAML frontmatter${NC}"
        ((errors++))
    fi

    # Required fields
    local name=$(extract_field "$skill_file" "name")
    local description=$(extract_field "$skill_file" "description")
    local license=$(extract_field "$skill_file" "license")
    local version=$(extract_metadata "$skill_file" "version")
    local author=$(extract_metadata "$skill_file" "author")
    local auto_invoke=$(extract_metadata "$skill_file" "auto_invoke")

    # Validate required fields
    if [ -z "$name" ]; then
        echo -e "  ${RED}ERROR: Missing 'name' field${NC}"
        ((errors++))
    elif [ "$name" != "$skill_folder" ]; then
        echo -e "  ${YELLOW}WARNING: name '$name' doesn't match folder '$skill_folder'${NC}"
        ((warnings++))
    fi

    if [ -z "$description" ]; then
        echo -e "  ${RED}ERROR: Missing 'description' field${NC}"
        ((errors++))
    fi

    if [ -z "$license" ]; then
        echo -e "  ${YELLOW}WARNING: Missing 'license' field${NC}"
        ((warnings++))
    fi

    if [ -z "$version" ]; then
        echo -e "  ${YELLOW}WARNING: Missing 'metadata.version' field${NC}"
        ((warnings++))
    fi

    if [ -z "$author" ]; then
        echo -e "  ${YELLOW}WARNING: Missing 'metadata.author' field${NC}"
        ((warnings++))
    fi

    if [ -z "$auto_invoke" ]; then
        echo -e "  ${YELLOW}WARNING: Missing 'metadata.auto_invoke' - skill won't auto-load${NC}"
        ((warnings++))
    fi

    # Validate dependencies exist
    local deps=$(extract_dependencies "$skill_file")
    if [ -n "$deps" ]; then
        local all_skills=$(get_all_skills)
        while IFS= read -r dep; do
            if ! echo "$all_skills" | grep -q "^${dep}$"; then
                echo -e "  ${RED}ERROR: Dependency '$dep' not found${NC}"
                ((errors++))
            fi
        done <<< "$deps"
    fi

    # Check for rules/ directory consistency
    if [ -d "$skill_dir/rules" ]; then
        local rule_count=$(find "$skill_dir/rules" -name "*.md" | wc -l | tr -d ' ')
        if [ "$rule_count" -eq 0 ]; then
            echo -e "  ${YELLOW}WARNING: Empty rules/ directory${NC}"
            ((warnings++))
        else
            echo -e "  ${GREEN}Found $rule_count rules${NC}"
        fi
    fi

    # Summary for this skill
    if [ $errors -eq 0 ] && [ $warnings -eq 0 ]; then
        echo -e "  ${GREEN}Valid${NC}"
    elif [ $errors -eq 0 ]; then
        echo -e "  ${YELLOW}Valid with $warnings warning(s)${NC}"
    fi

    ERRORS=$((ERRORS + errors))
    WARNINGS=$((WARNINGS + warnings))
    VALIDATED=$((VALIDATED + 1))
}

show_help() {
    echo "Usage: $0 [OPTIONS] [skill-name]"
    echo ""
    echo "Validate VanSkills definitions."
    echo ""
    echo "Options:"
    echo "  --help, -h    Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0                # Validate all skills"
    echo "  $0 react-19       # Validate specific skill"
    echo "  $0 rust typescript # Validate multiple skills"
}

# Parse arguments
SKILLS_TO_VALIDATE=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            SKILLS_TO_VALIDATE+=("$1")
            shift
            ;;
    esac
done

echo -e "${BLUE}VanSkills Validator${NC}"
echo "==================="
echo ""

if [ ${#SKILLS_TO_VALIDATE[@]} -eq 0 ]; then
    # Validate all skills
    while IFS= read -r skill_file; do
        [ -f "$skill_file" ] || continue
        validate_skill "$skill_file"
        echo ""
    done < <(find "$SKILLS_DIR" -mindepth 2 -maxdepth 2 -name SKILL.md -print | sort)
else
    # Validate specific skills
    for skill_name in "${SKILLS_TO_VALIDATE[@]}"; do
        skill_file="$SKILLS_DIR/$skill_name/SKILL.md"
        if [ -f "$skill_file" ]; then
            validate_skill "$skill_file"
            echo ""
        else
            echo -e "${RED}Skill not found: $skill_name${NC}"
            echo ""
            ERRORS=$((ERRORS + 1))
        fi
    done
fi

# Final summary
echo "==================="
echo -e "Validated: ${BLUE}$VALIDATED${NC} skill(s)"
echo -e "Errors:    ${RED}$ERRORS${NC}"
echo -e "Warnings:  ${YELLOW}$WARNINGS${NC}"
echo ""

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Validation failed!${NC}"
    exit 1
else
    echo -e "${GREEN}Validation passed!${NC}"
    exit 0
fi
