#!/usr/bin/env bash
# VanSkills - Sync skill metadata to AGENTS.md
# Usage: ./bin/sync [--dry-run]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
SKILLS_DIR="$REPO_ROOT/skills"
AGENTS_FILE="$REPO_ROOT/AGENTS.md"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Options
DRY_RUN=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [--dry-run]"
            echo ""
            echo "Options:"
            echo "  --dry-run    Show what would change without modifying files"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            exit 1
            ;;
    esac
done

# Extract YAML frontmatter field using awk
extract_field() {
    local file="$1"
    local field="$2"
    awk -v field="$field" '
        /^---$/ { in_frontmatter = !in_frontmatter; next }
        in_frontmatter && $1 == field":" {
            sub(/^[^:]+:[[:space:]]*/, "")
            if ($0 != "" && $0 != ">") {
                gsub(/^["'\'']|["'\'']$/, "")
                print
                exit
            }
            getline
            while (/^[[:space:]]/ && !/^---$/) {
                sub(/^[[:space:]]+/, "")
                printf "%s ", $0
                if (!getline) break
            }
            print ""
            exit
        }
    ' "$file" | sed 's/[[:space:]]*$//'
}

# Extract nested metadata field
extract_metadata() {
    local file="$1"
    local field="$2"

    awk -v field="$field" '
        function trim(s) {
            sub(/^[[:space:]]+/, "", s)
            sub(/[[:space:]]+$/, "", s)
            return s
        }

        /^---$/ { in_frontmatter = !in_frontmatter; next }

        in_frontmatter && /^metadata:/ { in_metadata = 1; next }
        in_frontmatter && in_metadata && /^[a-z]/ && !/^[[:space:]]/ { in_metadata = 0 }

        in_frontmatter && in_metadata && $1 == field":" {
            sub(/^[^:]+:[[:space:]]*/, "")

            if ($0 != "") {
                v = $0
                gsub(/^["'\'']|["'\'']$/, "", v)
                gsub(/^\[|\]$/, "", v)
                print trim(v)
                exit
            }

            out = ""
            while (getline) {
                if (!in_frontmatter) break
                if (!in_metadata) break
                if ($0 ~ /^[a-z]/ && $0 !~ /^[[:space:]]/) break

                line = $0
                if (line ~ /^[[:space:]]*-[[:space:]]*/) {
                    sub(/^[[:space:]]*-[[:space:]]*/, "", line)
                    line = trim(line)
                    gsub(/^["'\'']|["'\'']$/, "", line)
                    if (line != "") {
                        if (out == "") out = line
                        else out = out "|" line
                    }
                } else {
                    break
                }
            }

            if (out != "") print out
            exit
        }
    ' "$file"
}

echo -e "${BLUE}VanSkills - Sync to AGENTS.md${NC}"
echo "=============================="
echo ""

# Collect skills
declare -a SKILL_ENTRIES

while IFS= read -r skill_file; do
    [ -f "$skill_file" ] || continue

    skill_name=$(extract_field "$skill_file" "name")
    description=$(extract_field "$skill_file" "description" | head -c 80)
    auto_invoke_raw=$(extract_metadata "$skill_file" "auto_invoke")

    [ -z "$skill_name" ] && continue

    # Get relative path
    skill_dir=$(dirname "$skill_file")
    skill_rel_path="${skill_dir#$REPO_ROOT/}"

    SKILL_ENTRIES+=("$skill_name|$description|$skill_rel_path|$auto_invoke_raw")
done < <(find "$SKILLS_DIR" -mindepth 2 -maxdepth 2 -name SKILL.md -print | sort)

echo -e "${GREEN}Found ${#SKILL_ENTRIES[@]} skills${NC}"
echo ""

# Generate AGENTS.md content
AGENTS_CONTENT="# VanSkills - AI Agent Skills

> Skills are specialized instruction sets that teach AI assistants how to work with specific frameworks, libraries, and patterns.

## Available Skills

| Skill | Description | URL |
|-------|-------------|-----|"

for entry in "${SKILL_ENTRIES[@]}"; do
    IFS='|' read -r name desc path auto_invoke <<< "$entry"
    desc_short="${desc:0:60}"
    [ ${#desc} -gt 60 ] && desc_short="${desc_short}..."
    AGENTS_CONTENT="$AGENTS_CONTENT
| \`$name\` | $desc_short | [SKILL.md]($path/SKILL.md) |"
done

# Generate Auto-invoke section
AGENTS_CONTENT="$AGENTS_CONTENT

---

### Auto-invoke Skills

When performing these actions, ALWAYS invoke the corresponding skill FIRST:

| Action | Skill |
|--------|-------|"

for entry in "${SKILL_ENTRIES[@]}"; do
    IFS='|' read -r name desc path auto_invoke <<< "$entry"
    [ -z "$auto_invoke" ] && continue

    # Handle multiple auto_invoke actions (pipe-delimited)
    IFS='|' read -ra actions <<< "$auto_invoke"
    for action in "${actions[@]}"; do
        action="$(echo "$action" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')"
        [ -z "$action" ] && continue
        AGENTS_CONTENT="$AGENTS_CONTENT
| $action | \`$name\` |"
    done
done

AGENTS_CONTENT="$AGENTS_CONTENT

---

## Installation

To install these skills in any project:

\`\`\`bash
# Clone vanskills (if not already)
git clone https://github.com/vandev/vanskills.git ~/vanskills

# Run install script from target project
~/vanskills/bin/install
\`\`\`

## Creating New Skills

1. Copy template: \`cp templates/SKILL_TEMPLATE.md skills/my-skill/SKILL.md\`
2. Edit the skill with your patterns
3. Run \`./bin/sync\` to update AGENTS.md

---

Made with care by [vandev](https://github.com/vandev)
"

if $DRY_RUN; then
    echo -e "${YELLOW}[DRY RUN] Would write to $AGENTS_FILE:${NC}"
    echo ""
    echo "$AGENTS_CONTENT"
else
    echo "$AGENTS_CONTENT" > "$AGENTS_FILE"
    echo -e "${GREEN}Updated $AGENTS_FILE${NC}"
fi

# Show skills missing auto_invoke
echo ""
echo -e "${BLUE}Skills missing auto_invoke metadata:${NC}"
missing=0
for entry in "${SKILL_ENTRIES[@]}"; do
    IFS='|' read -r name desc path auto_invoke <<< "$entry"
    if [ -z "$auto_invoke" ]; then
        echo -e "  ${YELLOW}$name${NC}"
        missing=$((missing + 1))
    fi
done

if [ $missing -eq 0 ]; then
    echo -e "  ${GREEN}All skills have auto_invoke metadata${NC}"
fi

echo ""
echo -e "${GREEN}Done!${NC}"
